{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conectar WhatsApp - FUBOG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            background: linear-gradient(135deg, #003366 0%, #00A859 100%);
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-family: 'Segoe UI', sans-serif; 
        }
        .card-qr { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            text-align: center; 
            max-width: 500px; 
            width: 90%; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .qr-container {
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            min-height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .conectado { color: #28a745; }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 
            0%, 100% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.6; transform: scale(0.95); } 
        }
        .error-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
        }
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            text-align: left;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <div class="card-qr shadow-lg">
        <div class="mb-4">
            <i class="fa-brands fa-whatsapp text-success" style="font-size: 3rem;"></i>
            <h3 class="text-primary mt-2 mb-1">Conectar WhatsApp</h3>
            <small class="text-muted">Sistema FUBOG Trigger</small>
        </div>
        
        {% if erro_qr %}
            <!-- üîß MODO ERRO: Exibe detalhes do problema -->
            <div class="error-box mb-3">
                <div class="d-flex align-items-start">
                    <i class="fa-solid fa-triangle-exclamation text-warning fs-4 me-3 mt-1"></i>
                    <div class="text-start">
                        <strong class="text-danger">Erro ao obter QR Code</strong>
                        <p class="mb-2 mt-2 small">{{ erro_qr|linebreaks }}</p>
                        
                        {% if status_code %}
                            <span class="badge bg-danger">HTTP {{ status_code }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info border-0 small text-start mb-3">
                <strong><i class="fa-solid fa-lightbulb me-2"></i>Diagn√≥stico:</strong>
                <ul class="mb-0 mt-2">
                    <li>Verifique se a inst√¢ncia <code>{{ instancia_nome }}</code> existe no painel da UazApi</li>
                    <li>Confira se o <strong>admin_token</strong> est√° correto no c√≥digo</li>
                    <li>Teste a API diretamente: <a href="https://free.uazapi.com" target="_blank">free.uazapi.com</a></li>
                    <li>Verifique os logs do servidor Django para mais detalhes</li>
                </ul>
            </div>
            
            <!-- Debug Info (apenas em dev) -->
            {% if debug_info %}
                <details class="mb-3">
                    <summary class="btn btn-sm btn-outline-secondary w-100">üîç Informa√ß√µes de Debug</summary>
                    <div class="debug-panel mt-2">
                        <strong>Inst√¢ncia ID:</strong> {{ instancia_nome }}<br>
                        <strong>For√ßar Reconex√£o:</strong> {{ debug_info.forcar_reconexao }}<br>
                        <strong>Chaves na Resposta:</strong> {{ debug_info.chaves_encontradas|join:", " }}<br>
                        <strong>Status HTTP:</strong> {{ status_code }}
                    </div>
                </details>
            {% endif %}
            
        {% else %}
            <!-- üîß MODO SUCESSO: Exibe o QR Code -->
            <p class="text-muted mb-3">
                <i class="fa-solid fa-mobile-screen-button me-2"></i>
                Abra o WhatsApp, v√° em <strong>Aparelhos Conectados</strong> e escaneie:
            </p>
            
            <div class="qr-container mb-4" id="qr-container">
                {% if qr_code %}
                    <img src="{{ qr_code }}" alt="QR Code" class="img-fluid" style="max-width: 280px; max-height: 280px;" id="qr-image">
                {% else %}
                    <div class="text-center">
                        <div class="spinner-border text-primary loading" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="text-muted mt-3">Gerando QR Code...</p>
                    </div>
                {% endif %}
            </div>
            
            <div class="alert alert-warning border-0 small" id="status-alert">
                <i class="fa-solid fa-hourglass-end me-2"></i>
                <span id="status-text">Aguardando escaneamento...</span>
            </div>
        {% endif %}

        <!-- Bot√µes de A√ß√£o -->
        <div class="d-grid gap-2 mt-4">
            {% if not erro_qr and qr_code %}
                <button class="btn btn-success btn-lg shadow-sm" id="btn-continuar" disabled>
                    <i class="fa-solid fa-check me-2"></i>Aguarde... Conectando
                </button>
            {% else %}
                <a href="{% url 'conectar_whatsapp' %}?force=true" class="btn btn-primary btn-lg shadow-sm">
                    <i class="fa-solid fa-rotate me-2"></i>Tentar Novamente
                </a>
            {% endif %}
            
            <a href="{% url 'configurar' %}" class="btn btn-outline-secondary">
                <i class="fa-solid fa-arrow-left me-2"></i>Voltar para Login
            </a>
        </div>
        
        <!-- Info da Inst√¢ncia -->
        <div class="mt-4 pt-3 border-top">
            <div class="row text-start small text-muted">
                <div class="col-6">
                    <strong>Inst√¢ncia:</strong><br>
                    <code>{{ instancia_nome }}</code>
                </div>
                <div class="col-6">
                    <strong>Status:</strong><br>
                    <span id="api-status" class="badge bg-secondary">Verificando...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ [FUBOG] Script de conex√£o iniciado');
        
        // üîß CORRE√á√ÉO: Polling melhorado com feedback visual
        let tentativas = 0;
        const maxTentativas = 60; // 3 minutos (60 √ó 3s)
        let intervaloId = null;

        function verificarConexao() {
            console.log(`üîç [Tentativa ${tentativas + 1}/${maxTentativas}] Verificando conex√£o...`);
            
            fetch("{% url 'verificar_conexao' %}", {
                method: "GET",
                headers: { 
                    "X-Requested-With": "XMLHttpRequest",
                    "Cache-Control": "no-cache"
                }
            })
            .then(res => {
                console.log('üì° Status da requisi√ß√£o:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('üì¶ Dados recebidos:', data);
                
                const statusEl = document.getElementById("api-status");
                const statusTextEl = document.getElementById("status-text");
                const statusAlert = document.getElementById("status-alert");
                const btnContinuar = document.getElementById("btn-continuar");
                
                if (data.conectado) {
                    // ‚úÖ CONECTADO COM SUCESSO!
                    console.log('‚úÖ WhatsApp conectado com sucesso!');
                    
                    clearInterval(intervaloId);
                    
                    document.getElementById("qr-container").innerHTML = `
                        <div class="p-4 text-center">
                            <i class="fa-solid fa-check-circle text-success" style="font-size: 5rem;"></i>
                            <h5 class="mt-3 text-success">Conectado com Sucesso!</h5>
                            <p class="text-muted">Redirecionando para a configura√ß√£o...</p>
                        </div>
                    `;
                    
                    if (statusEl) {
                        statusEl.textContent = "Conectado";
                        statusEl.className = "badge bg-success";
                    }
                    
                    if (statusAlert) {
                        statusAlert.className = "alert alert-success border-0 small";
                        statusAlert.innerHTML = `
                            <i class="fa-solid fa-check-circle me-2"></i>
                            <strong>WhatsApp conectado!</strong> Redirecionando em 2 segundos...
                        `;
                    }
                    
                    if (btnContinuar) {
                        btnContinuar.disabled = false;
                        btnContinuar.innerHTML = '<i class="fa-solid fa-rocket me-2"></i>Ir para Configura√ß√£o';
                        btnContinuar.onclick = () => window.location.href = "{% url 'configurar' %}";
                    }
                    
                    setTimeout(() => {
                        window.location.href = "{% url 'configurar' %}";
                    }, 2000);
                    
                } else {
                    // ‚è≥ AINDA AGUARDANDO...
                    tentativas++;
                    
                    if (statusEl) {
                        statusEl.textContent = "Aguardando...";
                        statusEl.className = "badge bg-warning text-dark";
                    }
                    
                    if (statusTextEl) {
                        statusTextEl.innerHTML = `
                            <i class="fa-solid fa-hourglass-half me-2 loading"></i>
                            Aguardando escaneamento... (${tentativas}/${maxTentativas})
                        `;
                    }
                    
                    if (tentativas >= maxTentativas) {
                        console.warn('‚è±Ô∏è Timeout: Tempo m√°ximo de espera atingido');
                        clearInterval(intervaloId);
                        
                        if (statusEl) {
                            statusEl.textContent = "Timeout";
                            statusEl.className = "badge bg-danger";
                        }
                        
                        if (statusAlert) {
                            statusAlert.className = "alert alert-danger border-0 small";
                            statusAlert.innerHTML = `
                                <i class="fa-solid fa-clock me-2"></i>
                                <strong>Tempo esgotado!</strong> O QR Code expirou. Clique em "Tentar Novamente".
                            `;
                        }
                        
                        if (btnContinuar) {
                            btnContinuar.innerHTML = '<i class="fa-solid fa-rotate me-2"></i>Tentar Novamente';
                            btnContinuar.className = 'btn btn-warning btn-lg shadow-sm';
                            btnContinuar.disabled = false;
                            btnContinuar.onclick = () => location.reload();
                        }
                    }
                }
            })
            .catch(err => {
                console.error('Erro ao verificar conex√£o:', err);
            });
        }

        // üöÄ Inicia o polling apenas se h√° QR Code e n√£o h√° erro
        {% if qr_code and not erro_qr %}
            console.log('‚ñ∂Ô∏è Iniciando polling de verifica√ß√£o (a cada 3 segundos)');

            // Primeira verifica√ß√£o imediata
            setTimeout(verificarConexao, 1000);

            // Verifica√ß√µes subsequentes a cada 3 segundos
            intervaloId = setInterval(verificarConexao, 3000);
        {% else %}
            console.log('‚è∏Ô∏è Polling n√£o iniciado (sem QR Code ou com erro)');
        {% endif %}
    </script>

    <script>
        // Configura√ß√£o
        const ENDPOINT_VERIFICACAO = '/api/verificar-conexao/';
        const URL_DESTINO = '/admin/login/'; // ou '/accounts/login/' dependendo da sua rota
        const INTERVALO_CHECK = 3000; // 3 segundos

        async function monitorarConexao() {
            try {
                console.log("üì° Verificando status da conex√£o...");
                
                const response = await fetch(ENDPOINT_VERIFICACAO);
                
                if (response.status === 200) {
                    const data = await response.json();
                    
                    // UazAPI geralmente retorna status: 'open' ou 'connected' quando sucesso
                    // Ajuste 'data.conectado' conforme o retorno exato da sua View Django
                    if (data.conectado === true || data.status === 'open') {
                        
                        // UX: Feedback visual antes de redirecionar
                        document.body.innerHTML = `
                            <div style="display:flex; justify-content:center; align-items:center; height:100vh; background:#111827; color:#10b981; flex-direction:column; font-family:sans-serif;">
                                <h1>‚úÖ Conectado com Sucesso!</h1>
                                <p>Redirecionando para o login...</p>
                            </div>
                        `;
                        
                        // O Redirecionamento solicitado
                        setTimeout(() => {
                            window.location.href = URL_DESTINO;
                        }, 1500);
                        return; // Para o loop
                    }
                }
            } catch (error) {
                console.error("Erro silencioso ao verificar:", error);
            }

            // Loop recursivo (continua tentando se n√£o conectou)
            setTimeout(monitorarConexao, INTERVALO_CHECK);
        }

        // Inicia o monitoramento assim que a p√°gina carrega
        document.addEventListener('DOMContentLoaded', monitorarConexao);
    </script>

    <script>
        const URL_CHECK = '/api/verificar-conexao/';
        
        // Fun√ß√£o de verifica√ß√£o
        async function checarStatus() {
            try {
                console.log("üîç Perguntando ao servidor...");
                const res = await fetch(URL_CHECK);
                const data = await res.json();
                
                console.log("üì© Resposta:", data); // Olhe o Console do Navegador (F12)

                // L√≥gica de Redirecionamento
                if (data.conectado === true) {
                    console.log("‚úÖ DEU GREEN! Redirecionando...");
                    
                    // Feedback visual para o usu√°rio n√£o fechar a tela
                    document.body.innerHTML = `
                        <div style="height:100vh; display:flex; justify-content:center; align-items:center; background:#0f172a; color:#22c55e; flex-direction:column;">
                            <h1>üéâ Conectado!</h1>
                            <p>Redirecionando para o Dashboard...</p>
                        </div>
                    `;

                    setTimeout(() => {
                        // Redireciona para onde voc√™ quiser (Login ou Dashboard)
                        window.location.href = '/configurar/'; 
                    }, 1000);
                    
                    return; // Encerra o loop
                }

            } catch (erro) {
                console.error("‚ùå Erro no fetch:", erro);
            }

            // Tenta de novo em 3 segundos se n√£o conectou
            setTimeout(checarStatus, 3000);
        }

        // Inicia o loop
        document.addEventListener("DOMContentLoaded", () => {
            checarStatus();
        });
    </script>

</body>
</html>